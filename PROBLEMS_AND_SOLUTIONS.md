# üîß –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–µ–∫—Ç–∞

## üìã –ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä

–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –º—ã —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏. –í—Å–µ –æ–Ω–∏ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —Ä–µ—à–µ–Ω—ã. –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω —Å–ø–∏—Å–æ–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–π.

---

## 1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: Celery –∏ Redis

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
```
ERROR: Cannot install celery[redis]==5.3.4 and redis==5.0.1 
because these package versions have conflicting dependencies.
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
–ò–∑–º–µ–Ω–∏–ª–∏ –≤–µ—Ä—Å–∏—é Redis –≤ `requirements.txt`:
```python
# –ë—ã–ª–æ: redis==5.0.1
# –°—Ç–∞–ª–æ: redis==4.6.0
```
Celery[redis] —Ç—Ä–µ–±—É–µ—Ç `redis < 5.0.0`, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –≤–µ—Ä—Å–∏—é.

---

## 2. –ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π: list vs List

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
```python
TypeError: 'function' object is not subscriptable
# –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ list[Batch] –≤ Python 3.8+
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `List` –∏–∑ `typing` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:
```python
from typing import List
# list[Batch] ‚Üí List[Batch]
```

---

## 3. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç –≤ Redis –∫—ç—à–µ

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
```python
TypeError: Object of type date is not JSON serializable
# –ü—Ä–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–∏ BatchListResponse —Å –ø–æ–ª–µ–º batch_date
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
–°–æ–∑–¥–∞–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π JSON encoder –≤ `cache_service.py`:
```python
class DateEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, date):
            return obj.isoformat()
        return super().default(obj)
```

---

## 4. –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ SQLAlchemy (MissingGreenlet)

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
```python
MissingGreenlet: greenlet_spawn has not been called; 
can't call await_only() here.
# –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ—Å—Ç—É–ø–∞ –∫ products –≤–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `selectinload` –¥–ª—è eager loading:
```python
query = select(Batch).options(selectinload(Batch.products))
```

---

## 5. –ò–º–ø–æ—Ä—Ç—ã –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
```python
ModuleNotFoundError: No module named 'src'
# –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ scripts/init_minio.py –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
–ò—Å–ø—Ä–∞–≤–∏–ª–∏ –ø—É—Ç–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ —Å–∫—Ä–∏–ø—Ç–µ:
```python
# –î–æ–±–∞–≤–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º
sys.path.insert(0, '/app')
```

---

## 6. –ü—Ä–æ–±–ª–µ–º—ã —Å –ª–∏–Ω—Ç–µ—Ä–æ–º Ruff

### ‚ùå –ü—Ä–æ–±–ª–µ–º—ã
- `E712`: –°—Ä–∞–≤–Ω–µ–Ω–∏—è —Å `False/True`
- `F401`: –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã
- `E722`: Bare except clauses
- `B904`: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ü–µ–ø–æ—á–µ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
1. **E712**: –ó–∞–º–µ–Ω–∏–ª–∏ `== False` –Ω–∞ `not`, `== True` –Ω–∞ –ø—Ä—è–º—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
2. **F401**: –£–¥–∞–ª–∏–ª–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã
3. **E722**: –ó–∞–º–µ–Ω–∏–ª–∏ `except:` –Ω–∞ `except Exception:`
4. **B904**: –î–æ–±–∞–≤–∏–ª–∏ `from e` –∏–ª–∏ `from None` –∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º

–ü—Ä–∏–º–µ—Ä—ã:
```python
# –ë—ã–ª–æ: assert batch.is_closed == False
# –°—Ç–∞–ª–æ: assert not batch.is_closed

# –ë—ã–ª–æ: except:
# –°—Ç–∞–ª–æ: except Exception:

# –ë—ã–ª–æ: raise Exception(f"Error: {e}")
# –°—Ç–∞–ª–æ: raise Exception(f"Error: {e}") from e
```

---

## 7. –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–º–ø–æ—Ä—Ç–∞–º–∏ –≤ —Ç–µ—Å—Ç–∞—Ö

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
```python
ModuleNotFoundError: No module named 'celery'
# –ü—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–∏–ª–∏ graceful handling –≤ —Ç–µ—Å—Ç—ã:
```python
try:
    from src.celery_app import celery_app
except ImportError:
    print("‚ö†Ô∏è  Celery not available (expected in test environment)")
```

---

## 8. –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –∏–º–ø–æ—Ä—Ç–æ–≤

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
```python
I001: Import block is un-sorted or un-formatted
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
```bash
ruff check --fix .
ruff format .
```

---

## 9. Webhook —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞–≥–≥—Ä–µ–≥–∞—Ü–∏–∏

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
Webhook —Å–æ–±—ã—Ç–∏–µ `product_aggregated` –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞–≥–≥—Ä–µ–≥–∞—Ü–∏–∏.

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫—É webhook –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞–≥–≥—Ä–µ–≥–∞—Ü–∏–∏:
```python
# –í src/api/batches.py
if aggregated_count > 0:
    await webhook_service.send_webhook(
        event_type="product_aggregated",
        payload={"batch_id": batch_id, "count": aggregated_count}
    )
```

---

## 10. –ü–∞—Ä—Å–∏–Ω–≥ URL MinIO –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ URL MinIO –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã.

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä URL:
```python
from urllib.parse import urlparse, unquote

def parse_minio_url(url: str):
    parsed = urlparse(url)
    bucket = parsed.path.split('/')[1] if parsed.path else None
    object_name = '/'.join(parsed.path.split('/')[2:])
    return bucket, unquote(object_name)
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

- **–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º**: 10
- **–†–µ—à–µ–Ω–æ**: 10 ‚úÖ
- **–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö**: 3 (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, —Ç–∏–ø–∏–∑–∞—Ü–∏—è, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è)
- **–°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö**: 4 (–ª–∏–Ω—Ç–µ—Ä, –∏–º–ø–æ—Ä—Ç—ã)
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö**: 3 (webhooks, –∏–º–ø–æ—Ä—Ç, –∑–∞–≥—Ä—É–∑–∫–∞)

---

## üéØ –í—ã–≤–æ–¥—ã

1. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** - —Ä–µ—à–∞—é—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–π
2. **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - –≤–∞–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Å—Å–∏—è–º–∏ –ë–î
4. **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞** - –ª–∏–Ω—Ç–µ—Ä—ã –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤–∞–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö

–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã, –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! ‚úÖ
